<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="考試報時提醒系統 - 專業的考試時間管理工具">
    <meta name="keywords" content="考試, 報時, 提醒, 時間管理, 學校">
    <meta name="author" content="Examination Timing Alert System">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./images/favicon.png">
    
    <title>考試報時提醒系統</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- TailwindCSS Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E3A8A',
                        secondary: '#374151',
                        accent: '#D97706',
                        warning: '#D97706',
                        surface: '#F8FAFC',
                        'surface-dark': '#0F172A'
                    },
                    fontFamily: {
                        'mono': ['Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'monospace']
                    }
                }
            }
        }
    </script>
    
    <!-- Custom Styles -->
    <style>
        /* Animation Styles */
        .warning-flash {
            animation: flash 2s infinite;
        }
        
        @keyframes flash {
            0%, 50% { 
                background-color: #FEF3C7; 
                border-color: #D97706; 
            }
            51%, 100% { 
                background-color: #F59E0B; 
                border-color: #92400E; 
            }
        }
        
        .dark .warning-flash {
            animation: flash-dark 2s infinite;
        }
        
        @keyframes flash-dark {
            0%, 50% { 
                background-color: #92400E; 
                border-color: #D97706; 
            }
            51%, 100% { 
                background-color: #B45309; 
                border-color: #F59E0B; 
            }
        }
        
        .urgent-flash {
            animation: urgent 1s infinite;
        }
        
        @keyframes urgent {
            0%, 50% { 
                background-color: #FEF3C7; 
                border-color: #D97706; 
            }
            51%, 100% { 
                background-color: #F59E0B; 
                border-color: #92400E; 
            }
        }
        
        .dark .urgent-flash {
            animation: urgent-dark 1s infinite;
        }
        
        @keyframes urgent-dark {
            0%, 50% { 
                background-color: #92400E; 
                border-color: #D97706; 
            }
            51%, 100% { 
                background-color: #B45309; 
                border-color: #F59E0B; 
            }
        }
        
        /* Enhanced Visual Effects */
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .dark .glass-effect {
            background: rgba(15, 23, 42, 0.95);
        }
        
        .time-display {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }
        
        .dark .time-display {
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
        }
        
        /* Accessibility Improvements */
        @media (prefers-reduced-motion: reduce) {
            .warning-flash,
            .urgent-flash {
                animation: none;
                background-color: #FEF3C7 !important;
            }
            
            .dark .warning-flash,
            .dark .urgent-flash {
                background-color: #92400E !important;
            }
        }
        
        /* Print Styles */
        @media print {
            .warning-flash,
            .urgent-flash {
                animation: none;
                background-color: #FEF3C7 !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
        }
        
        /* Enhanced Mobile Responsiveness */
        @media (max-width: 640px) {
            .time-display {
                font-size: 3rem !important;
            }
        }
        
        /* Focus Indicators */
        input:focus,
        button:focus {
            outline: 2px solid #1E3A8A;
            outline-offset: 2px;
        }
        
        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen font-sans">
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-primary text-white px-4 py-2 rounded">
        跳至主要內容
    </a>

    <!-- Header -->
    <header class="bg-primary dark:bg-slate-800 border-b-4 border-accent shadow-lg">
        <div class="container mx-auto p-6 max-w-7xl">
            <div class="flex items-center justify-center gap-6">
                <img 
                    src="./images/NDC_school_logov2.png" 
                    alt="學校校徽" 
                    class="h-16 w-16 object-contain"
                    loading="eager"
                    onerror="this.style.display='none'"
                >
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-white tracking-wider">
                        考試報時提醒系統
                    </h1>
                    <p class="text-blue-100 dark:text-slate-300 mt-2 text-lg">
                        EXAMINATION TIMING ALERT SYSTEM
                    </p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="container mx-auto p-6 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-[25%_25%_50%] gap-8">
            
            <!-- Time Configuration Panel -->
            <section class="order-2 lg:order-1" aria-labelledby="config-title">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg">
                    <header class="bg-secondary text-white p-4 border-b-2 border-slate-300 dark:border-slate-600 rounded-t-lg">
                        <h2 id="config-title" class="text-xl font-bold text-center tracking-wide">
                            考試時間設定
                        </h2>
                        <p class="text-center text-slate-200 text-sm mt-1">
                            EXAM TIME CONFIGURATION
                        </p>
                    </header>
                    
                    <div class="p-6">
                        <!-- Form 1 Configuration -->
                        <fieldset class="mb-8">
                            <legend class="sr-only">中一年級時間設定</legend>
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary rounded">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">
                                    中一年級 FORM 1
                                </h3>
                            </div>
                            
                            <div class="mb-4">
                                <label for="form1End1" class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 block">
                                    第一節 SESSION 1
                                </label>
                                <input 
                                    type="time" 
                                    id="form1End1" 
                                    class="w-full px-4 py-3 border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-base font-mono focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all rounded"
                                    aria-describedby="form1End1-desc"
                                >
                                <span id="form1End1-desc" class="sr-only">設定中一年級第一節考試結束時間</span>
                            </div>
                            
                            <div class="mb-4">
                                <label for="form1End2" class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 block">
                                    第二節 SESSION 2
                                </label>
                                <input 
                                    type="time" 
                                    id="form1End2" 
                                    class="w-full px-4 py-3 border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-base font-mono focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all rounded"
                                    aria-describedby="form1End2-desc"
                                >
                                <span id="form1End2-desc" class="sr-only">設定中一年級第二節考試結束時間</span>
                            </div>
                        </fieldset>

                        <!-- Form 2 Configuration -->
                        <fieldset class="mb-8">
                            <legend class="sr-only">中二年級時間設定</legend>
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary rounded">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">
                                    中二年級 FORM 2
                                </h3>
                            </div>
                            
                            <div class="mb-4">
                                <label for="form2End1" class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 block">
                                    第一節 SESSION 1
                                </label>
                                <input 
                                    type="time" 
                                    id="form2End1" 
                                    class="w-full px-4 py-3 border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-base font-mono focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all rounded"
                                    aria-describedby="form2End1-desc"
                                >
                                <span id="form2End1-desc" class="sr-only">設定中二年級第一節考試結束時間</span>
                            </div>
                            
                            <div class="mb-4">
                                <label for="form2End2" class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 block">
                                    第二節 SESSION 2
                                </label>
                                <input 
                                    type="time" 
                                    id="form2End2" 
                                    class="w-full px-4 py-3 border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-base font-mono focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all rounded"
                                    aria-describedby="form2End2-desc"
                                >
                                <span id="form2End2-desc" class="sr-only">設定中二年級第二節考試結束時間</span>
                            </div>
                        </fieldset>

                        <!-- Form 3 Configuration -->
                        <fieldset class="mb-8">
                            <legend class="sr-only">中三年級時間設定</legend>
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary rounded">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">
                                    中三年級 FORM 3
                                </h3>
                            </div>
                            
                            <div class="mb-4">
                                <label for="form3End1" class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 block">
                                    第一節 SESSION 1
                                </label>
                                <input 
                                    type="time" 
                                    id="form3End1" 
                                    class="w-full px-4 py-3 border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-base font-mono focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all rounded"
                                    aria-describedby="form3End1-desc"
                                >
                                <span id="form3End1-desc" class="sr-only">設定中三年級第一節考試結束時間</span>
                            </div>
                            
                            <div class="mb-4">
                                <label for="form3End2" class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 block">
                                    第二節 SESSION 2
                                </label>
                                <input 
                                    type="time" 
                                    id="form3End2" 
                                    class="w-full px-4 py-3 border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-base font-mono focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all rounded"
                                    aria-describedby="form3End2-desc"
                                >
                                <span id="form3End2-desc" class="sr-only">設定中三年級第二節考試結束時間</span>
                            </div>
                        </fieldset>

                        <button 
                            onclick="resetAllTimes()" 
                            class="w-full bg-secondary hover:bg-slate-600 text-white py-3 px-6 font-semibold tracking-wide uppercase transition-colors border-2 border-secondary hover:border-slate-600 rounded focus:ring-2 focus:ring-offset-2 focus:ring-secondary"
                            aria-describedby="reset-desc"
                        >
                            重置所有設定 RESET ALL
                        </button>
                        <span id="reset-desc" class="sr-only">清除所有時間設定</span>
                    </div>
                </div>
            </section>

            <!-- Time Display Panel -->
            <section class="order-1 lg:order-2" aria-labelledby="remaining-title">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg">
                    <header class="bg-secondary text-white p-4 border-b-2 border-slate-300 dark:border-slate-600 rounded-t-lg">
                        <h2 id="remaining-title" class="text-xl font-bold text-center tracking-wide">
                            剩餘時間
                        </h2>
                        <p class="text-center text-slate-200 text-sm mt-1">
                            REMAINING TIME
                        </p>
                    </header>
                    
                    <div class="p-6">
                        <!-- Form 1 Times -->
                        <div class="mb-8">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary rounded">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">中一年級</h3>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第一節 SESSION 1</div>
                                <div id="form1Session1" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form1Session1Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第二節 SESSION 2</div>
                                <div id="form1Session2" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form1Session2Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Form 2 Times -->
                        <div class="mb-8">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary rounded">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">中二年級</h3>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第一節 SESSION 1</div>
                                <div id="form2Session1" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form2Session1Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第二節 SESSION 2</div>
                                <div id="form2Session2" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form2Session2Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Form 3 Times -->
                        <div class="mb-6">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary rounded">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">中三年級</h3>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第一節 SESSION 1</div>
                                <div id="form3Session1" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form3Session1Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第二節 SESSION 2</div>
                                <div id="form3Session2" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form3Session2Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Clock and Alerts Panel -->
            <section class="order-3 lg:order-3">
                <!-- Current Time Display -->
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl mb-8 rounded-lg">
                    <header class="bg-primary text-white p-4 border-b-2 border-blue-800 rounded-t-lg">
                        <h2 class="text-xl font-bold text-center tracking-wide">香港標準時間</h2>
                        <p class="text-center text-blue-100 text-sm mt-1">HONG KONG STANDARD TIME</p>
                    </header>
                    <div class="p-8 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 rounded-b-lg">
                        <div class="text-center">
                            <time 
                                id="currentTime" 
                                class="text-6xl xl:text-7xl font-bold font-mono text-primary dark:text-blue-300 time-display tracking-wider mb-4 block"
                                role="timer"
                                aria-live="polite"
                            ></time>
                            <div id="currentDate" class="text-lg text-slate-600 dark:text-slate-400 font-medium"></div>
                        </div>
                    </div>
                </div>
                
                <!-- System Alerts -->
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg">
                    <header class="bg-accent text-white p-4 border-b-2 border-yellow-800 rounded-t-lg">
                        <h3 class="text-xl font-bold text-center tracking-wide">系統提醒</h3>
                        <p class="text-center text-yellow-100 text-sm mt-1">SYSTEM ALERTS</p>
                    </header>
                    <div class="p-6">
                        <div id="alertsList" class="space-y-3" role="log" aria-live="polite" aria-label="系統提醒列表">
                            <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                                <div class="text-lg font-semibold">暫無提醒</div>
                                <div class="text-sm mt-1">NO ALERTS</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Audio Enable Button (iOS Compatibility) -->
    <div id="audioEnableOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-lg max-w-md mx-4 text-center">
            <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-slate-100">啟用語音提醒</h3>
            <p class="text-slate-600 dark:text-slate-400 mb-6">
                為了在 iOS 設備上播放語音提醒，請點擊下方按鈕啟用音頻功能。
            </p>
            <button id="enableAudioBtn" class="bg-primary hover:bg-blue-700 text-white px-6 py-3 rounded font-semibold transition-colors">
                啟用語音提醒
            </button>
            <button id="disableAudioBtn" class="ml-4 bg-slate-500 hover:bg-slate-600 text-white px-6 py-3 rounded font-semibold transition-colors">
                靜音模式
            </button>
        </div>
    </div>

    <!-- JavaScript Application -->
    <script>
        'use strict';
        
        // Application State
        const AppState = {
            alertHistory: new Set(),
            timeAlertHistory: new Set(),
            isPlayingAudio: false,
            timers: new Map(),
            audioEnabled: false,
            audioInitialized: false,
            audioCache: new Map(),
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent)
        };

        // Utility Functions
        const Utils = {
            formatTime(date) {
                return date.toLocaleTimeString('zh-HK', {
                    timeZone: 'Asia/Hong_Kong',
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            },

            formatDate(date) {
                return date.toLocaleDateString('zh-HK', {
                    timeZone: 'Asia/Hong_Kong',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
            },

            getHongKongTime() {
                return new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // Dark Mode Manager
        const DarkMode = {
            init() {
                // Initial check
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
                
                // Listen for changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
            }
        };

        // Time Calculator
        const TimeCalculator = {
            calculateTimeRemaining(endTime) {
                if (!endTime) return null;
                
                const now = Utils.getHongKongTime();
                const [hours, minutes] = endTime.split(':');
                const examEnd = new Date(now);
                examEnd.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                if (examEnd < now) {
                    examEnd.setDate(examEnd.getDate() + 1);
                }
                
                const diff = examEnd - now;
                
                if (diff <= 0) {
                    return { ended: true, text: '考試已結束' };
                }
                
                const totalSeconds = Math.floor(diff / 1000);
                const hours_remaining = Math.floor(totalSeconds / 3600);
                const minutes_remaining = Math.floor((totalSeconds % 3600) / 60);
                const seconds_remaining = totalSeconds % 60;
                
                return {
                    ended: false,
                    totalSeconds,
                    hours: hours_remaining,
                    minutes: minutes_remaining,
                    seconds: seconds_remaining,
                    text: `${hours_remaining.toString().padStart(2, '0')}:${minutes_remaining.toString().padStart(2, '0')}:${seconds_remaining.toString().padStart(2, '0')}`
                };
            }
        };

        // iOS Audio Manager
        const IOSAudioManager = {
            init() {
                // Show audio enable overlay on iOS devices
                if (AppState.isIOS) {
                    this.showAudioEnableOverlay();
                } else {
                    AppState.audioEnabled = true;
                    AppState.audioInitialized = true;
                }
            },

            showAudioEnableOverlay() {
                const overlay = document.getElementById('audioEnableOverlay');
                const enableBtn = document.getElementById('enableAudioBtn');
                const disableBtn = document.getElementById('disableAudioBtn');

                overlay.classList.remove('hidden');

                enableBtn.addEventListener('click', async () => {
                    try {
                        await this.initializeAudio();
                        AppState.audioEnabled = true;
                        AppState.audioInitialized = true;
                        overlay.classList.add('hidden');
                        console.log('iOS 音頻已啟用');
                    } catch (error) {
                        console.error('iOS 音頻初始化失敗:', error);
                        AppState.audioEnabled = false;
                        overlay.classList.add('hidden');
                    }
                });

                disableBtn.addEventListener('click', () => {
                    AppState.audioEnabled = false;
                    AppState.audioInitialized = true;
                    overlay.classList.add('hidden');
                    console.log('iOS 靜音模式已啟用');
                });
            },

            async initializeAudio() {
                // Create a silent audio file to unlock iOS audio
                const silentAudio = new Audio();
                silentAudio.src = 'data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAATIAAAABBZD14AAIAJggDAAAeqOmk8QAAQKADhgJgA==';
                silentAudio.preload = 'auto';
                
                return new Promise((resolve, reject) => {
                    silentAudio.addEventListener('canplaythrough', () => {
                        silentAudio.play().then(() => {
                            console.log('iOS 音頻解鎖成功');
                            resolve();
                        }).catch(reject);
                    });
                    
                    silentAudio.addEventListener('error', reject);
                    silentAudio.load();
                });
            },

            async preloadAudio() {
                if (!AppState.audioEnabled) return;

                const audioFiles = [
                    './voice/S1.mp3',
                    './voice/S2.mp3', 
                    './voice/S3.mp3',
                    './voice/alarm.mp3',
                    './voice/15mins.mp3',
                    './voice/5mins.mp3',
                    './voice/end.mp3'
                ];

                const preloadPromises = audioFiles.map(src => {
                    return new Promise((resolve) => {
                        const audio = new Audio();
                        audio.preload = 'auto';
                        audio.src = src;
                        
                        audio.addEventListener('canplaythrough', () => {
                            AppState.audioCache.set(src, audio);
                            console.log(`預載音頻: ${src}`);
                            resolve();
                        });
                        
                        audio.addEventListener('error', () => {
                            console.warn(`預載失敗: ${src}`);
                            resolve();
                        });
                        
                        audio.load();
                    });
                });

                await Promise.all(preloadPromises);
                console.log('音頻預載完成');
            }
        };

        // Audio System
        const AudioSystem = {
            async playAudioFile(src) {
                if (!AppState.audioEnabled || !AppState.audioInitialized) {
                    console.log(`音頻已禁用，跳過播放: ${src}`);
                    return;
                }

                return new Promise((resolve) => {
                    let audio;
                    
                    // Use cached audio if available
                    if (AppState.audioCache.has(src)) {
                        audio = AppState.audioCache.get(src);
                        // Reset to beginning
                        audio.currentTime = 0;
                    } else {
                        audio = new Audio(src);
                        audio.preload = 'auto';
                    }
                    
                    audio.onloadeddata = () => {
                        console.log(`載入語音文件: ${src}`);
                    };
                    
                    audio.onended = () => {
                        console.log(`播放完成: ${src}`);
                        resolve();
                    };
                    
                    audio.onerror = (error) => {
                        console.error(`語音文件載入失敗: ${src}`, error);
                        resolve(); // Continue even if failed
                    };
                    
                    // iOS specific handling
                    if (AppState.isIOS) {
                        audio.load();
                    }
                    
                    audio.play().catch(error => {
                        console.error(`播放失敗: ${src}`, error);
                        resolve(); // Continue even if failed
                    });
                });
            },

            async playAudioSequence(message) {
                if (!AppState.audioEnabled || AppState.isPlayingAudio) return;
                
                AppState.isPlayingAudio = true;
                
                try {
                    const forms = [];
                    if (message.includes('中一')) forms.push('中一');
                    if (message.includes('中二')) forms.push('中二');
                    if (message.includes('中三')) forms.push('中三');
                    
                    const audioFiles = [];
                    const formOrder = ['中一', '中二', '中三'];
                    
                    formOrder.forEach((form, index) => {
                        if (forms.includes(form)) {
                            audioFiles.push(`./voice/S${index + 1}.mp3`);
                        }
                    });
                    audioFiles.push('./voice/alarm.mp3');
                    
                    for (let round = 0; round < 2; round++) {
                        for (const audioFile of audioFiles) {
                            await this.playAudioFile(audioFile);
                        }
                        if (round === 0) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                } catch (error) {
                    console.error('語音播放錯誤:', error);
                } finally {
                    AppState.isPlayingAudio = false;
                }
            },

            async playTimeAlertSequence(forms, minutes) {
                if (!AppState.audioEnabled || AppState.isPlayingAudio) return;
                
                AppState.isPlayingAudio = true;
                
                try {
                    const audioFiles = [];
                    const formOrder = ['中一', '中二', '中三'];
                    
                    formOrder.forEach((form, index) => {
                        if (forms.includes(form)) {
                            audioFiles.push(`./voice/S${index + 1}.mp3`);
                        }
                    });
                    
                    if (minutes === 0) {
                        audioFiles.push('./voice/end.mp3');
                    } else {
                        audioFiles.push(`./voice/${minutes}mins.mp3`);
                    }
                    
                    console.log(`播放時間提醒語音: ${forms.join(' ')} ${minutes === 0 ? '考試結束' : minutes + '分鐘'}`, audioFiles);
                    
                    for (let round = 0; round < 2; round++) {
                        for (const audioFile of audioFiles) {
                            await this.playAudioFile(audioFile);
                        }
                        if (round === 0) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                } catch (error) {
                    console.error('時間提醒語音播放錯誤:', error);
                } finally {
                    AppState.isPlayingAudio = false;
                }
            }
        };

        // Alert Manager
        const AlertManager = {
            addAlert(message, type = 'info', relatedForms = []) {
                const alertsList = document.getElementById('alertsList');
                const placeholder = alertsList.querySelector('div');
                if (placeholder && placeholder.textContent.includes('暫無提醒')) {
                    placeholder.remove();
                }
                
                const alertDiv = document.createElement('div');
                const alertClass = type === 'urgent' ? 
                    'urgent-flash border-accent text-yellow-900 dark:text-yellow-100' : 
                    type === 'warning' ? 
                    'warning-flash border-warning text-yellow-900 dark:text-yellow-100' : 
                    'bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 text-slate-800 dark:text-slate-200';
                
                alertDiv.className = `p-4 border-2 ${alertClass} transition-all rounded`;
                alertDiv.setAttribute('role', 'alert');
                alertDiv.setAttribute('aria-live', 'assertive');
                
                alertDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-lg">${message}</div>
                            <div class="text-sm opacity-75 mt-1">${Utils.formatTime(Utils.getHongKongTime())}</div>
                        </div>
                        <button onclick="AlertManager.removeAlert(this)" class="text-xl opacity-70 hover:opacity-100 font-bold ml-4 hover:bg-white hover:bg-opacity-20 w-8 h-8 flex items-center justify-center transition-all rounded" aria-label="關閉提醒">×</button>
                    </div>
                `;
                
                alertDiv.dataset.relatedForms = JSON.stringify(relatedForms);
                alertsList.insertBefore(alertDiv, alertsList.firstChild);
                
                let countdown = 60;
                const countdownTimer = setInterval(() => {
                    countdown--;
                    
                    const messageElement = alertDiv.querySelector('.font-bold');
                    if (messageElement) {
                        if (countdown <= 10 && countdown > 0) {
                            messageElement.innerHTML = `${message} <span class="countdown-timer text-xs opacity-60 ml-2">(${countdown}s)</span>`;
                        } else if (countdown > 10) {
                            messageElement.innerHTML = message;
                        }
                    }
                    
                    if (countdown <= 0) {
                        clearInterval(countdownTimer);
                        this.removeAlert(alertDiv.querySelector('button'), true);
                    }
                }, 1000);
                
                alertDiv.dataset.timerId = countdownTimer;
                AppState.timers.set(alertDiv, countdownTimer);
                
                AudioSystem.playAudioSequence(message);
            },

            removeAlert(buttonOrElement, isAutoRemove = false) {
                let alertDiv;
                if (buttonOrElement.tagName === 'BUTTON') {
                    alertDiv = buttonOrElement.parentElement.parentElement;
                } else {
                    alertDiv = buttonOrElement;
                }
                
                if (alertDiv.dataset.timerId) {
                    clearInterval(parseInt(alertDiv.dataset.timerId));
                    AppState.timers.delete(alertDiv);
                }
                
                if (isAutoRemove && alertDiv.dataset.relatedForms) {
                    try {
                        const relatedForms = JSON.parse(alertDiv.dataset.relatedForms);
                        relatedForms.forEach(formInfo => {
                            const container = document.getElementById(`${formInfo.form}${formInfo.session}`);
                            if (container) {
                                const endTimeInput = document.getElementById(`${formInfo.form}End${formInfo.sessionIndex + 1}`);
                                const timeRemaining = TimeCalculator.calculateTimeRemaining(endTimeInput.value);
                                
                                if (timeRemaining && !timeRemaining.ended) {
                                    let className = 'py-3 px-4 border-2 transition-all border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 rounded';
                                    container.className = className;
                                }
                            }
                        });
                    } catch (e) {
                        console.error('解析相關年級信息失敗:', e);
                    }
                }
                
                alertDiv.remove();
                
                const alertsList = document.getElementById('alertsList');
                if (alertsList.children.length === 0) {
                    alertsList.innerHTML = `
                        <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                            <div class="text-lg font-semibold">暫無提醒</div>
                            <div class="text-sm mt-1">NO ALERTS</div>
                        </div>
                    `;
                }
            }
        };

        // Alert Checker
        const AlertChecker = {
            checkAndProcessAlerts() {
                const forms = ['form1', 'form2', 'form3'];
                const formNames = ['中一', '中二', '中三'];
                const sessions = ['Session1', 'Session2'];
                const sessionNames = ['第一節', '第二節'];
                
                const alertsToProcess = [];
                
                forms.forEach((form, formIndex) => {
                    sessions.forEach((session, sessionIndex) => {
                        const endTimeInput = document.getElementById(`${form}End${sessionIndex + 1}`);
                        const endTime = endTimeInput.value;
                        const timeRemaining = TimeCalculator.calculateTimeRemaining(endTime);
                        
                        if (!timeRemaining || timeRemaining.ended) return;
                        
                        const totalSeconds = timeRemaining.totalSeconds;
                        const alertKey = `${formNames[formIndex]}-${sessionNames[sessionIndex]}`;
                        
                        const alerts = [
                            { seconds: 930, message: '15分鐘', type: 'warning' },
                            { seconds: 330, message: '5分鐘', type: 'warning' },
                            { seconds: 30, message: '預備收卷', type: 'urgent' }
                        ];
                        
                        alerts.forEach(alert => {
                            const alertId = `${alertKey}-${alert.seconds}`;
                            if (totalSeconds <= alert.seconds && totalSeconds > alert.seconds - 5 && !AppState.alertHistory.has(alertId)) {
                                alertsToProcess.push({
                                    formName: formNames[formIndex],
                                    sessionName: sessionNames[sessionIndex],
                                    alertSeconds: alert.seconds,
                                    message: alert.message,
                                    type: alert.type,
                                    alertId: alertId
                                });
                                AppState.alertHistory.add(alertId);
                            }
                        });
                    });
                });
                
                const groupedAlerts = {};
                alertsToProcess.forEach(alert => {
                    const groupKey = `${alert.sessionName}-${alert.alertSeconds}`;
                    if (!groupedAlerts[groupKey]) {
                        groupedAlerts[groupKey] = {
                            sessionName: alert.sessionName,
                            message: alert.message,
                            type: alert.type,
                            forms: []
                        };
                    }
                    groupedAlerts[groupKey].forms.push(alert.formName);
                });
                
                Object.values(groupedAlerts).forEach(group => {
                    const formsText = group.forms.join(' ');
                    let alertMessage;
                    
                    if (group.message === '預備收卷') {
                        alertMessage = `${formsText} ${group.sessionName} ${group.message}`;
                    } else {
                        alertMessage = `${formsText} ${group.sessionName} 尚餘 ${group.message}`;
                    }
                    
                    const relatedForms = [];
                    const forms = ['form1', 'form2', 'form3'];
                    const formNames = ['中一', '中二', '中三'];
                    const sessions = ['Session1', 'Session2'];
                    const sessionNames = ['第一節', '第二節'];
                    
                    group.forms.forEach(formName => {
                        const formIndex = formNames.indexOf(formName);
                        const sessionIndex = sessionNames.indexOf(group.sessionName);
                        if (formIndex !== -1 && sessionIndex !== -1) {
                            relatedForms.push({
                                form: forms[formIndex],
                                session: sessions[sessionIndex],
                                sessionIndex: sessionIndex
                            });
                        }
                    });
                    
                    AlertManager.addAlert(alertMessage, group.type, relatedForms);
                });
            },

            checkTimeAlerts() {
                const forms = ['form1', 'form2', 'form3'];
                const formNames = ['中一', '中二', '中三'];
                const sessions = ['Session1', 'Session2'];
                const sessionNames = ['第一節', '第二節'];
                
                const specificMinutes = [15, 5, 0];
                
                specificMinutes.forEach(targetMinutes => {
                    const formsAtTime = [];
                    
                    forms.forEach((form, formIndex) => {
                        sessions.forEach((session, sessionIndex) => {
                            const endTimeInput = document.getElementById(`${form}End${sessionIndex + 1}`);
                            const endTime = endTimeInput.value;
                            const timeRemaining = TimeCalculator.calculateTimeRemaining(endTime);
                            
                            if (!timeRemaining) return;
                            
                            let shouldTrigger = false;
                            
                            if (targetMinutes === 0) {
                                shouldTrigger = timeRemaining.ended;
                            } else {
                                if (!timeRemaining.ended) {
                                    const totalMinutes = Math.floor(timeRemaining.totalSeconds / 60);
                                    const seconds = timeRemaining.totalSeconds % 60;
                                    shouldTrigger = (totalMinutes === targetMinutes && seconds <= 2);
                                }
                            }
                            
                            if (shouldTrigger) {
                                const formKey = `${formNames[formIndex]}-${sessionNames[sessionIndex]}`;
                                if (!formsAtTime.some(item => item.form === formNames[formIndex])) {
                                    formsAtTime.push({
                                        form: formNames[formIndex],
                                        session: sessionNames[sessionIndex],
                                        key: formKey
                                    });
                                }
                            }
                        });
                    });
                    
                    if (formsAtTime.length > 0) {
                        const timeAlertKey = `${targetMinutes}mins-${formsAtTime.map(f => f.form).sort().join('-')}`;
                        
                        if (!AppState.timeAlertHistory.has(timeAlertKey)) {
                            AppState.timeAlertHistory.add(timeAlertKey);
                            const formsList = formsAtTime.map(f => f.form);
                            AudioSystem.playTimeAlertSequence(formsList, targetMinutes);
                            console.log(`觸發時間提醒: ${formsList.join(' ')} ${targetMinutes === 0 ? '考試結束' : targetMinutes + '分鐘'}`);
                        }
                    }
                });
            }
        };

        // Display Manager
        const DisplayManager = {
            updateDisplay() {
                const now = Utils.getHongKongTime();
                document.getElementById('currentTime').textContent = Utils.formatTime(now);
                document.getElementById('currentDate').textContent = Utils.formatDate(now);
                
                const forms = ['form1', 'form2', 'form3'];
                const sessions = ['Session1', 'Session2'];
                
                forms.forEach((form, formIndex) => {
                    sessions.forEach((session, sessionIndex) => {
                        const endTimeInput = document.getElementById(`${form}End${sessionIndex + 1}`);
                        const timeDisplay = document.getElementById(`${form}${session}Time`);
                        const container = document.getElementById(`${form}${session}`);
                        
                        const endTime = endTimeInput.value;
                        const timeRemaining = TimeCalculator.calculateTimeRemaining(endTime);
                        
                        if (!endTime) {
                            timeDisplay.textContent = '--:--:--';
                            container.className = container.className.replace(/warning-flash|urgent-flash|border-accent|border-warning/g, '').trim() + ' py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded';
                        } else if (timeRemaining.ended) {
                            timeDisplay.textContent = timeRemaining.text;
                            container.className = 'py-3 px-4 border-2 border-accent bg-yellow-100 dark:bg-yellow-900 transition-all rounded';
                        } else {
                            timeDisplay.textContent = timeRemaining.text;
                            
                            let className = 'py-3 px-4 border-2 transition-all rounded ';
                            if (timeRemaining.totalSeconds <= 30) {
                                className += 'urgent-flash border-accent';
                            } else if (timeRemaining.totalSeconds <= 330) {
                                className += 'warning-flash border-warning';
                            } else if (timeRemaining.totalSeconds <= 930) {
                                className += 'warning-flash border-warning';
                            } else {
                                className += 'border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700';
                            }
                            container.className = className;
                        }
                    });
                });
            }
        };

        // Global Functions (for inline event handlers)
        function resetAllTimes() {
            const inputs = document.querySelectorAll('input[type="time"]');
            inputs.forEach(input => input.value = '');
            AppState.alertHistory.clear();
            AppState.timeAlertHistory.clear();
            
            // Clear all timers
            AppState.timers.forEach(timer => clearInterval(timer));
            AppState.timers.clear();
            
            const alertsList = document.getElementById('alertsList');
            alertsList.innerHTML = `
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <div class="text-lg font-semibold">暫無提醒</div>
                    <div class="text-sm mt-1">NO ALERTS</div>
                </div>
            `;
            
            DisplayManager.updateDisplay();
        }

        // Application Initialization
        async function initApp() {
            try {
                // Initialize dark mode
                DarkMode.init();
                
                // Initialize iOS audio manager
                IOSAudioManager.init();
                
                // Preload audio files after user interaction (if enabled)
                if (AppState.audioEnabled) {
                    await IOSAudioManager.preloadAudio();
                }
                
                // Set up input event listeners
                document.querySelectorAll('input[type="time"]').forEach(input => {
                    input.addEventListener('change', Utils.debounce(async () => {
                        AppState.alertHistory.clear();
                        AppState.timeAlertHistory.clear();
                        DisplayManager.updateDisplay();
                        
                        // Preload audio if not already done and audio is enabled
                        if (AppState.audioEnabled && AppState.audioCache.size === 0) {
                            await IOSAudioManager.preloadAudio();
                        }
                    }, 300));
                });
                
                // Start main update loop
                setInterval(() => {
                    DisplayManager.updateDisplay();
                    
                    // Only check alerts if audio system is initialized
                    if (AppState.audioInitialized) {
                        AlertChecker.checkAndProcessAlerts();
                        AlertChecker.checkTimeAlerts();
                    }
                }, 1000);
                
                // Initial display update
                DisplayManager.updateDisplay();
                
                console.log('考試報時提醒系統已初始化');
                console.log(`設備類型: ${AppState.isIOS ? 'iOS' : '其他'}`);
                console.log(`音頻狀態: ${AppState.audioEnabled ? '已啟用' : '已禁用'}`);
            } catch (error) {
                console.error('應用程式初始化失敗:', error);
            }
        }

        // Error Handling
        window.addEventListener('error', (event) => {
            console.error('JavaScript錯誤:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('未處理的Promise拒絕:', event.reason);
        });

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Page Visibility API - pause when tab is not visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('應用程式已暫停');
            } else {
                console.log('應用程式已恢復');
            }
        });
    </script>
</body>
</html>
