<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考試報時提醒程式</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E3A8A',      // 深藍色
                        secondary: '#374151',    // 深灰色
                        accent: '#D97706',       // 深黃色
                        warning: '#D97706',      // 深橙色
                        surface: '#F8FAFC',      // 淺灰白
                        'surface-dark': '#0F172A' // 深色表面
                    },
                    fontFamily: {
                        'mono': ['Monaco', 'Menlo', 'Ubuntu Mono', 'monospace']
                    }
                }
            }
        }
    </script>
    <style>
        .warning-flash {
            animation: flash 2s infinite;
        }
        @keyframes flash {
            0%, 50% { background-color: #FEF3C7; border-color: #D97706; }
            51%, 100% { background-color: #F59E0B; border-color: #92400E; }
        }
        .dark .warning-flash {
            animation: flash-dark 2s infinite;
        }
        @keyframes flash-dark {
            0%, 50% { background-color: #92400E; border-color: #D97706; }
            51%, 100% { background-color: #B45309; border-color: #F59E0B; }
        }
        .urgent-flash {
            animation: urgent 1s infinite;
        }
        @keyframes urgent {
            0%, 50% { background-color: #FEF3C7; border-color: #D97706; }
            51%, 100% { background-color: #F59E0B; border-color: #92400E; }
        }
        .dark .urgent-flash {
            animation: urgent-dark 1s infinite;
        }
        @keyframes urgent-dark {
            0%, 50% { background-color: #92400E; border-color: #D97706; }
            51%, 100% { background-color: #B45309; border-color: #F59E0B; }
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .dark .glass-effect {
            background: rgba(15, 23, 42, 0.95);
        }
        .time-display {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .dark .time-display {
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen font-sans">
    <!-- 頂部標題區 -->
    <div class="bg-primary dark:bg-slate-800 border-b-4 border-accent shadow-lg">
        <div class="container mx-auto p-6 max-w-7xl">
            <div class="flex items-center justify-center gap-6">
                <img src="./images/NDC_school_logov2.png" alt="學校校徽" class="h-16 w-16 object-contain">
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-white tracking-wider">考試報時提醒系統</h1>
                    <p class="text-blue-100 dark:text-slate-300 mt-2 text-lg">EXAMINATION TIMING ALERT SYSTEM</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-6 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-[25%_25%_50%] gap-8">
            <!-- 左欄：考試結束時間設定 -->
            <div class="order-2 lg:order-1">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl">
                    <div class="bg-secondary text-white p-4 border-b-2 border-slate-300 dark:border-slate-600">
                        <h2 class="text-xl font-bold text-center tracking-wide">考試時間設定</h2>
                        <p class="text-center text-slate-200 text-sm mt-1">EXAM TIME CONFIGURATION</p>
                    </div>
                    <div class="p-6">
                        <!-- 中一設定 -->
                        <div class="mb-8">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">中一年級 FORM 1</h3>
                            </div>
                            
                            <!-- 第一節 -->
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第一節 SESSION 1</div>
                                <input type="time" id="form1End1" class="w-full px-4 py-3 border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-base font-mono focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
                            </div>
                            
                            <!-- 第二節 -->
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第二節 SESSION 2</div>
                                <input type="time" id="form1End2" class="w-full px-4 py-3 border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-base font-mono focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
                            </div>
                        </div>

                        <!-- 中二設定 -->
                        <div class="mb-8">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">中二年級 FORM 2</h3>
                            </div>
                            
                            <!-- 第一節 -->
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第一節 SESSION 1</div>
                                <input type="time" id="form2End1" class="w-full px-4 py-3 border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-base font-mono focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
                            </div>
                            
                            <!-- 第二節 -->
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第二節 SESSION 2</div>
                                <input type="time" id="form2End2" class="w-full px-4 py-3 border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-base font-mono focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
                            </div>
                        </div>

                        <!-- 中三設定 -->
                        <div class="mb-8">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">中三年級 FORM 3</h3>
                            </div>
                            
                            <!-- 第一節 -->
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第一節 SESSION 1</div>
                                <input type="time" id="form3End1" class="w-full px-4 py-3 border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-base font-mono focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
                            </div>
                            
                            <!-- 第二節 -->
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第二節 SESSION 2</div>
                                <input type="time" id="form3End2" class="w-full px-4 py-3 border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-base font-mono focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
                            </div>
                        </div>

                        <button onclick="resetAllTimes()" class="w-full bg-secondary hover:bg-slate-600 text-white py-3 px-6 font-semibold tracking-wide uppercase transition-colors border-2 border-secondary hover:border-slate-600">
                            重置所有設定 RESET ALL
                        </button>
                    </div>
                </div>
            </div>

            <!-- 中欄：剩餘時間 -->
            <div class="order-1 lg:order-2">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl">
                    <div class="bg-secondary text-white p-4 border-b-2 border-slate-300 dark:border-slate-600">
                        <h2 class="text-xl font-bold text-center tracking-wide">剩餘時間</h2>
                        <p class="text-center text-slate-200 text-sm mt-1">REMAINING TIME</p>
                    </div>
                    <div class="p-6">
                        <!-- 中一 -->
                        <div class="mb-8">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">中一年級</h3>
                            </div>
                            
                            <!-- 第一節 -->
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第一節 SESSION 1</div>
                                <div id="form1Session1" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all">
                                    <div id="form1Session1Time" class="text-base font-bold font-mono tracking-wider">--:--:--</div>
                                </div>
                            </div>
                            
                            <!-- 第二節 -->
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第二節 SESSION 2</div>
                                <div id="form1Session2" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all">
                                    <div id="form1Session2Time" class="text-base font-bold font-mono tracking-wider">--:--:--</div>
                                </div>
                            </div>
                        </div>

                        <!-- 中二 -->
                        <div class="mb-8">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">中二年級</h3>
                            </div>
                            
                            <!-- 第一節 -->
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第一節 SESSION 1</div>
                                <div id="form2Session1" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all">
                                    <div id="form2Session1Time" class="text-base font-bold font-mono tracking-wider">--:--:--</div>
                                </div>
                            </div>
                            
                            <!-- 第二節 -->
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第二節 SESSION 2</div>
                                <div id="form2Session2" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all">
                                    <div id="form2Session2Time" class="text-base font-bold font-mono tracking-wider">--:--:--</div>
                                </div>
                            </div>
                        </div>

                        <!-- 中三 -->
                        <div class="mb-6">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">中三年級</h3>
                            </div>
                            
                            <!-- 第一節 -->
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第一節 SESSION 1</div>
                                <div id="form3Session1" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all">
                                    <div id="form3Session1Time" class="text-base font-bold font-mono tracking-wider">--:--:--</div>
                                </div>
                            </div>
                            
                            <!-- 第二節 -->
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">第二節 SESSION 2</div>
                                <div id="form3Session2" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all">
                                    <div id="form3Session2Time" class="text-base font-bold font-mono tracking-wider">--:--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右欄：當前時間與提醒 -->
            <div class="order-3 lg:order-3">
                <!-- 時間顯示 -->
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl mb-8">
                    <div class="bg-primary text-white p-4 border-b-2 border-blue-800">
                        <h2 class="text-xl font-bold text-center tracking-wide">香港標準時間</h2>
                        <p class="text-center text-blue-100 text-sm mt-1">HONG KONG STANDARD TIME</p>
                    </div>
                    <div class="p-8 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900">
                        <div class="text-center">
                            <div id="currentTime" class="text-6xl xl:text-7xl font-bold font-mono text-primary dark:text-blue-300 time-display tracking-wider mb-4"></div>
                            <div id="currentDate" class="text-lg text-slate-600 dark:text-slate-400 font-medium"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 提醒區域 -->
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl">
                    <div class="bg-accent text-white p-4 border-b-2 border-yellow-800">
                        <h3 class="text-xl font-bold text-center tracking-wide">系統提醒</h3>
                        <p class="text-center text-yellow-100 text-sm mt-1">SYSTEM ALERTS</p>
                    </div>
                    <div class="p-6">
                        <div id="alertsList" class="space-y-3">
                            <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                                <div class="text-lg font-semibold">暫無提醒</div>
                                <div class="text-sm mt-1">NO ALERTS</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 深色模式支援
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        let alertHistory = new Set(); // 追蹤已發出的提醒
        let timeAlertHistory = new Set(); // 追蹤已播放的時間提醒

        function formatTime(date) {
            return date.toLocaleTimeString('zh-HK', {
                timeZone: 'Asia/Hong_Kong',
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function formatDate(date) {
            return date.toLocaleDateString('zh-HK', {
                timeZone: 'Asia/Hong_Kong',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
        }

        function getHongKongTime() {
            return new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
        }

        function calculateTimeRemaining(endTime) {
            if (!endTime) return null;
            
            const now = getHongKongTime();
            const [hours, minutes] = endTime.split(':');
            const examEnd = new Date(now);
            examEnd.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            // 如果結束時間是明天
            if (examEnd < now) {
                examEnd.setDate(examEnd.getDate() + 1);
            }
            
            const diff = examEnd - now;
            
            if (diff <= 0) {
                return { ended: true, text: '考試已結束' };
            }
            
            const totalSeconds = Math.floor(diff / 1000);
            const hours_remaining = Math.floor(totalSeconds / 3600);
            const minutes_remaining = Math.floor((totalSeconds % 3600) / 60);
            const seconds_remaining = totalSeconds % 60;
            
            return {
                ended: false,
                totalSeconds,
                hours: hours_remaining,
                minutes: minutes_remaining,
                seconds: seconds_remaining,
                text: `${hours_remaining.toString().padStart(2, '0')}:${minutes_remaining.toString().padStart(2, '0')}:${seconds_remaining.toString().padStart(2, '0')}`
            };
        }

        function checkAndProcessAlerts() {
            const forms = ['form1', 'form2', 'form3'];
            const formNames = ['中一', '中二', '中三'];
            const sessions = ['Session1', 'Session2'];
            const sessionNames = ['第一節', '第二節'];
            
            // 收集所有需要提醒的情況
            const alertsToProcess = [];
            
            forms.forEach((form, formIndex) => {
                sessions.forEach((session, sessionIndex) => {
                    const endTimeInput = document.getElementById(`${form}End${sessionIndex + 1}`);
                    const endTime = endTimeInput.value;
                    const timeRemaining = calculateTimeRemaining(endTime);
                    
                    if (!timeRemaining || timeRemaining.ended) return;
                    
                    const totalSeconds = timeRemaining.totalSeconds;
                    const alertKey = `${formNames[formIndex]}-${sessionNames[sessionIndex]}`;
                    
                    // 檢查是否需要提醒
                    const alerts = [
                        { seconds: 930, message: '15分鐘', type: 'warning' },
                        { seconds: 330, message: '5分鐘', type: 'warning' },
                        { seconds: 30, message: '預備收卷', type: 'urgent' }
                    ];
                    
                    alerts.forEach(alert => {
                        const alertId = `${alertKey}-${alert.seconds}`;
                        if (totalSeconds <= alert.seconds && totalSeconds > alert.seconds - 5 && !alertHistory.has(alertId)) {
                            alertsToProcess.push({
                                formName: formNames[formIndex],
                                sessionName: sessionNames[sessionIndex],
                                alertSeconds: alert.seconds,
                                message: alert.message,
                                type: alert.type,
                                alertId: alertId
                            });
                            alertHistory.add(alertId);
                        }
                    });
                });
            });
            
            // 按節次和提醒類型分組
            const groupedAlerts = {};
            alertsToProcess.forEach(alert => {
                const groupKey = `${alert.sessionName}-${alert.alertSeconds}`;
                if (!groupedAlerts[groupKey]) {
                    groupedAlerts[groupKey] = {
                        sessionName: alert.sessionName,
                        message: alert.message,
                        type: alert.type,
                        forms: []
                    };
                }
                groupedAlerts[groupKey].forms.push(alert.formName);
            });
            
            // 生成合併的提醒訊息
            Object.values(groupedAlerts).forEach(group => {
                const formsText = group.forms.join(' ');
                let alertMessage;
                
                if (group.message === '預備收卷') {
                    alertMessage = `${formsText} ${group.sessionName} ${group.message}`;
                } else {
                    alertMessage = `${formsText} ${group.sessionName} 尚餘 ${group.message}`;
                }
                
                // 準備相關年級信息用於後續停止閃爍
                const relatedForms = [];
                const forms = ['form1', 'form2', 'form3'];
                const formNames = ['中一', '中二', '中三'];
                const sessions = ['Session1', 'Session2'];
                const sessionNames = ['第一節', '第二節'];
                
                group.forms.forEach(formName => {
                    const formIndex = formNames.indexOf(formName);
                    const sessionIndex = sessionNames.indexOf(group.sessionName);
                    if (formIndex !== -1 && sessionIndex !== -1) {
                        relatedForms.push({
                            form: forms[formIndex],
                            session: sessions[sessionIndex],
                            sessionIndex: sessionIndex
                        });
                    }
                });
                
                addAlert(alertMessage, group.type, relatedForms);
            });
        }

        // 語音播放系統
        let isPlayingAudio = false;
        
        async function playAudioSequence(message) {
            if (isPlayingAudio) return; // 防止重複播放
            
            isPlayingAudio = true;
            
            try {
                // 分析訊息中涉及的年級數量
                const forms = [];
                if (message.includes('中一')) forms.push('中一');
                if (message.includes('中二')) forms.push('中二');
                if (message.includes('中三')) forms.push('中三');
                
                // 根據年級數量決定播放的語音文件
                const audioFiles = [];
                for (let i = 1; i <= forms.length; i++) {
                    audioFiles.push(`./voice/S${i}.mp3`);
                }
                audioFiles.push('./voice/alarm.mp3');
                
                // 播放兩次完整序列
                for (let round = 0; round < 2; round++) {
                    for (const audioFile of audioFiles) {
                        await playAudioFile(audioFile);
                    }
                    // 兩輪之間稍作停頓
                    if (round === 0) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            } catch (error) {
                console.error('語音播放錯誤:', error);
            } finally {
                isPlayingAudio = false;
            }
        }

        // 時間提醒語音播放系統
        async function playTimeAlertSequence(forms, minutes) {
            if (isPlayingAudio) return; // 防止重複播放
            
            isPlayingAudio = true;
            
            try {
                const audioFiles = [];
                
                // 根據年級順序添加對應的語音文件
                const formOrder = ['中一', '中二', '中三'];
                
                formOrder.forEach((form, index) => {
                    if (forms.includes(form)) {
                        audioFiles.push(`./voice/S${index + 1}.mp3`);
                    }
                });
                
                // 根據分鐘數添加對應的語音文件
                if (minutes === 0) {
                    audioFiles.push('./voice/end.mp3');
                } else {
                    audioFiles.push(`./voice/${minutes}mins.mp3`);
                }
                
                console.log(`播放時間提醒語音: ${forms.join(' ')} ${minutes === 0 ? '考試結束' : minutes + '分鐘'}`, audioFiles);
                
                // 播放兩次完整序列
                for (let round = 0; round < 2; round++) {
                    for (const audioFile of audioFiles) {
                        await playAudioFile(audioFile);
                    }
                    // 兩輪之間稍作停頓
                    if (round === 0) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            } catch (error) {
                console.error('時間提醒語音播放錯誤:', error);
            } finally {
                isPlayingAudio = false;
            }
        }
        
        function playAudioFile(src) {
            return new Promise((resolve, reject) => {
                const audio = new Audio(src);
                
                audio.onloadeddata = () => {
                    console.log(`載入語音文件: ${src}`);
                };
                
                audio.onended = () => {
                    console.log(`播放完成: ${src}`);
                    resolve();
                };
                
                audio.onerror = (error) => {
                    console.error(`語音文件載入失敗: ${src}`, error);
                    resolve(); // 即使失敗也繼續播放下一個
                };
                
                audio.play().catch(error => {
                    console.error(`播放失敗: ${src}`, error);
                    resolve(); // 即使失敗也繼續播放下一個
                });
            });
        }

        function addAlert(message, type = 'info', relatedForms = []) {
            const alertsList = document.getElementById('alertsList');
            const placeholder = alertsList.querySelector('div');
            if (placeholder && placeholder.textContent.includes('暫無提醒')) {
                placeholder.remove();
            }
            
            const alertDiv = document.createElement('div');
            const alertClass = type === 'urgent' ? 
                'urgent-flash border-accent text-yellow-900 dark:text-yellow-100' : 
                type === 'warning' ? 
                'warning-flash border-warning text-yellow-900 dark:text-yellow-100' : 
                'bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 text-slate-800 dark:text-slate-200';
            
            alertDiv.className = `p-4 border-2 ${alertClass} transition-all`;
            
            // 創建基本HTML結構（不包含倒數計時）
            alertDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-bold text-lg">${message}</div>
                        <div class="text-sm opacity-75 mt-1">${formatTime(getHongKongTime())}</div>
                    </div>
                    <button onclick="removeAlert(this)" class="text-xl opacity-70 hover:opacity-100 font-bold ml-4 hover:bg-white hover:bg-opacity-20 w-8 h-8 flex items-center justify-center transition-all">×</button>
                </div>
            `;
            
            // 存儲相關的年級和節次信息
            alertDiv.dataset.relatedForms = JSON.stringify(relatedForms);
            
            alertsList.insertBefore(alertDiv, alertsList.firstChild);
            
            // 1分鐘倒數計時器
            let countdown = 60;
            const countdownTimer = setInterval(() => {
                countdown--;
                
                // 當剩餘時間少於等於10秒時，顯示倒數計時
                const messageElement = alertDiv.querySelector('.font-bold');
                if (messageElement) {
                    if (countdown <= 10 && countdown > 0) {
                        // 顯示倒數計時
                        messageElement.innerHTML = `${message} <span class="countdown-timer text-xs opacity-60 ml-2">(${countdown}s)</span>`;
                    } else if (countdown > 10) {
                        // 不顯示倒數計時
                        messageElement.innerHTML = message;
                    }
                }
                
                if (countdown <= 0) {
                    clearInterval(countdownTimer);
                    removeAlert(alertDiv.querySelector('button'), true);
                }
            }, 1000);
            
            // 存儲計時器ID以便手動刪除時清除
            alertDiv.dataset.timerId = countdownTimer;
            
            // 播放對應的語音提醒
            playAudioSequence(message);
        }
        
        function removeAlert(buttonOrElement, isAutoRemove = false) {
            let alertDiv;
            if (buttonOrElement.tagName === 'BUTTON') {
                alertDiv = buttonOrElement.parentElement.parentElement;
            } else {
                alertDiv = buttonOrElement;
            }
            
            // 清除計時器
            if (alertDiv.dataset.timerId) {
                clearInterval(parseInt(alertDiv.dataset.timerId));
            }
            
            // 如果是自動刪除，需要停止相關年級的閃爍效果
            if (isAutoRemove && alertDiv.dataset.relatedForms) {
                try {
                    const relatedForms = JSON.parse(alertDiv.dataset.relatedForms);
                    relatedForms.forEach(formInfo => {
                        const container = document.getElementById(`${formInfo.form}${formInfo.session}`);
                        if (container) {
                            // 重新計算當前時間狀態
                            const endTimeInput = document.getElementById(`${formInfo.form}End${formInfo.sessionIndex + 1}`);
                            const timeRemaining = calculateTimeRemaining(endTimeInput.value);
                            
                            if (timeRemaining && !timeRemaining.ended) {
                                // 重新設定正確的樣式（不閃爍）
                                let className = 'py-3 px-4 border-2 transition-all border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700';
                                container.className = className;
                            }
                        }
                    });
                } catch (e) {
                    console.error('解析相關年級信息失敗:', e);
                }
            }
            
            // 移除提醒元素
            alertDiv.remove();
            
            // 如果沒有提醒了，顯示預設訊息
            const alertsList = document.getElementById('alertsList');
            if (alertsList.children.length === 0) {
                alertsList.innerHTML = `
                    <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                        <div class="text-lg font-semibold">暫無提醒</div>
                        <div class="text-sm mt-1">NO ALERTS</div>
                    </div>
                `;
            }
        }

        function updateDisplay() {
            const now = getHongKongTime();
            document.getElementById('currentTime').textContent = formatTime(now);
            document.getElementById('currentDate').textContent = formatDate(now);
            
            // 更新各級各節的剩餘時間
            const forms = ['form1', 'form2', 'form3'];
            const formNames = ['中一', '中二', '中三'];
            const sessions = ['Session1', 'Session2'];
            const sessionNames = ['第一節', '第二節'];
            
            forms.forEach((form, formIndex) => {
                sessions.forEach((session, sessionIndex) => {
                    const endTimeInput = document.getElementById(`${form}End${sessionIndex + 1}`);
                    const timeDisplay = document.getElementById(`${form}${session}Time`);
                    const container = document.getElementById(`${form}${session}`);
                    
                    const endTime = endTimeInput.value;
                    const timeRemaining = calculateTimeRemaining(endTime);
                    
                    if (!endTime) {
                        timeDisplay.textContent = '--:--:--';
                        container.className = container.className.replace(/warning-flash|urgent-flash|border-accent|border-warning/g, '').trim() + ' py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all';
                    } else if (timeRemaining.ended) {
                        timeDisplay.textContent = timeRemaining.text;
                        container.className = 'py-3 px-4 border-2 border-accent bg-yellow-100 dark:bg-yellow-900 transition-all';
                    } else {
                        timeDisplay.textContent = timeRemaining.text;
                        
                        // 設定視覺提醒
                        let className = 'py-3 px-4 border-2 transition-all ';
                        if (timeRemaining.totalSeconds <= 30) {
                            className += 'urgent-flash border-accent';
                        } else if (timeRemaining.totalSeconds <= 330) {
                            className += 'warning-flash border-warning';
                        } else if (timeRemaining.totalSeconds <= 930) {
                            className += 'warning-flash border-warning';
                        } else {
                            className += 'border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700';
                        }
                        container.className = className;
                    }
                });
            });
        }

        function resetAllTimes() {
            const inputs = document.querySelectorAll('input[type="time"]');
            inputs.forEach(input => input.value = '');
            alertHistory.clear();
            timeAlertHistory.clear(); // 清除時間提醒歷史
            
            // 清除提醒列表
            const alertsList = document.getElementById('alertsList');
            alertsList.innerHTML = `
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <div class="text-lg font-semibold">暫無提醒</div>
                    <div class="text-sm mt-1">NO ALERTS</div>
                </div>
            `;
            
            updateDisplay();
        }

        // 監聽輸入變化
        document.querySelectorAll('input[type="time"]').forEach(input => {
            input.addEventListener('change', () => {
                alertHistory.clear(); // 重置提醒歷史
                timeAlertHistory.clear(); // 重置時間提醒歷史
                updateDisplay();
            });
        });

        // 檢查特定分鐘時間提醒
        function checkTimeAlerts() {
            const forms = ['form1', 'form2', 'form3'];
            const formNames = ['中一', '中二', '中三'];
            const sessions = ['Session1', 'Session2'];
            const sessionNames = ['第一節', '第二節'];
            
            // 檢查的特定分鐘數
            const specificMinutes = [15, 5, 0];
            
            specificMinutes.forEach(targetMinutes => {
                const formsAtTime = [];
                
                forms.forEach((form, formIndex) => {
                    sessions.forEach((session, sessionIndex) => {
                        const endTimeInput = document.getElementById(`${form}End${sessionIndex + 1}`);
                        const endTime = endTimeInput.value;
                        const timeRemaining = calculateTimeRemaining(endTime);
                        
                        if (!timeRemaining) return;
                        
                        let shouldTrigger = false;
                        
                        if (targetMinutes === 0) {
                            // 檢查是否剛好結束（剩餘時間為0）
                            shouldTrigger = timeRemaining.ended;
                        } else {
                            // 檢查是否剛好等於目標分鐘數（允許2秒誤差）
                            if (!timeRemaining.ended) {
                                const totalMinutes = Math.floor(timeRemaining.totalSeconds / 60);
                                const seconds = timeRemaining.totalSeconds % 60;
                                shouldTrigger = (totalMinutes === targetMinutes && seconds <= 2);
                            }
                        }
                        
                        if (shouldTrigger) {
                            const formKey = `${formNames[formIndex]}-${sessionNames[sessionIndex]}`;
                            if (!formsAtTime.some(item => item.form === formNames[formIndex])) {
                                formsAtTime.push({
                                    form: formNames[formIndex],
                                    session: sessionNames[sessionIndex],
                                    key: formKey
                                });
                            }
                        }
                    });
                });
                
                // 如果有年級達到目標時間，播放語音
                if (formsAtTime.length > 0) {
                    const timeAlertKey = `${targetMinutes}mins-${formsAtTime.map(f => f.form).sort().join('-')}`;
                    
                    if (!timeAlertHistory.has(timeAlertKey)) {
                        timeAlertHistory.add(timeAlertKey);
                        const formsList = formsAtTime.map(f => f.form);
                        playTimeAlertSequence(formsList, targetMinutes);
                        console.log(`觸發時間提醒: ${formsList.join(' ')} ${targetMinutes === 0 ? '考試結束' : targetMinutes + '分鐘'}`);
                    }
                }
            });
        }

        // 每秒更新一次
        setInterval(() => {
            updateDisplay();
            checkAndProcessAlerts();
            checkTimeAlerts();
        }, 1000);
        
        // 初始化顯示
        updateDisplay();
    </script>
</body>
</html>
